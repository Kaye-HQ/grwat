---
title: "Introduction to grwat R package"
author: "Timofey Samsonov"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Read and preprocess the source data 

## Read raw discharge data

The starting point for hydrograph analysis is to obtain the source data. Let's see how it goes with sample `spas-zagorye.txt` discharge data for $1956-2020$ year range provided with grwat. This data is for [Spas-Zogorye](https://allrivers.info/gauge/protva-obninsk) gauge on [Protva](https://en.wikipedia.org/wiki/Protva) river in Central European plane:

```{r, message=FALSE, warning=FALSE}
library(sf)
library(tidyverse)
library(grwat)
library(mapview)

# this is path to sample data installed with grwat
path = system.file("extdata", "spas-zagorye.txt", package = "grwat")

# for your own data just provide the full path:
# path = /this/is/the/path/to/discharge/discharge.csv

hdata = read_delim(path, col_names = c('d', 'm', 'y', 'q'), col_types = 'iiid', delim = ' ') # read gauge data
head(hdata) # see the data
```

This example contains the minimum amount of data needed to use the grwat. The first three columns encode the date, and the last column is the main variable â€” discharge. If the date is encoded as a single column instead of three separate columns, this is also perfect for grwat as input:

```{r}
hdata_alt = hdata %>% 
  transmute(D = lubridate::make_date(y, m, d), 
            Q = q)
head(hdata_alt)
```

## Join meteorological variables

A sole discharge data is enough to separate the hydrograph into quickflow and baseflow, but is not sufficient to predict the genesis of quickflow cases. Was it due to rain or thaw? To answer such questions you also need precipitation and temperature data. Ideally, these must be measured at the gauge. But often such data is not available. In this case you need to mine this data from external sources.

One of the ways to obtain the temperature and precipitation data is to use reanalyses such as [ERA5](https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5). Reanalysis data is arranged as regular grids with specific resolution. In particular, the ERA5 data has $31$ km or $0.28125$ degrees resolution. To use such data you must tolerate the fact that none of the reanalysis grid nodes will coincide with your gauge. Instead, you have to use the data, which is either

- the closest reanalysis point
- all points falling within the buffer zone of the gauge
- all points falling within the basin of the the gauge.
- all points falling within the buffer zone of the basin of the the gauge.

The last two options are the most adequate. Let's see how it can be done with the buffered basin scenario. First, we need to read the basin spatial data:

```{r}

# this is path to sample basin geopackage installed with grwat
path = system.file("extdata", "spas-zagorye.gpkg", package = "grwat")

# for your own data just provide the full path:
# path = /this/is/the/path/to/discharge/basin.shp

basin = st_read(path) # read basin region
mapview(basin)
```

Next, we can buffer the data on the specified distance to catch more reanalysis data:
```{r}
basin_buf = gr_buffer_geo(basin, 25000) 
mapview(basin_buf, col.regions = 'red') +
  mapview(basin)
```


After reanalysis data are joined you can easily plot a map of the derived spatial configuration with
```{r, message=FALSE, warning=FALSE}
grwat::map(rean$pts, hdata_rean$pts, basin, basin_pr) # plot spatial configuration
```

# Separate and describe {#separate}

Currently separation and description procedures are unavalable inside grwat package and are performed using external command-line Fortran^[In the next release of grwat package separation stage will be rewritten in C++ using Rcpp package to provide the complete workflow inside R ecosystem] program that produces two files:

- _AllGrWat.txt_ contains hydrograph separation data
- _Total.txt_ contains multiple variables describing the separated hydrograph

These output data can be visualised and statistically assessed by grwat functions that are uncovered in the next section. 

We recommend placing these files in the same folder as processed data like in a picture below:

![](sep_files.png)

# Plot and test

These functions from grwat package allow you to:

- Plot separation of hydrograph
- Plot interannual changes of key water discharge variables
- Plot long-term changes of key water discharge variables
- Perform statistical tests on all calculated variables

> Currently only English locale is provided in plots. In future releases Russian locale will also be added

## Plot separation of hydrograph

To plot separation of hydrograph you need results of a separation procedure which are saved as _AllGrWat.txt_ text file (see previous section). This file is read by `read_separation()` function:

```{r, message=FALSE}
setwd("/Volumes/Work/_grwat/Mezen_Malonisog/")

sep = grwat::read_separation('AllGrWat.txt')#
head(sep)
```

You can then plot separations for selected years using `plot_separation()` function:
```{r}
grwat::plot_separation(sep, 1978) # plot single year
grwat::plot_separation(sep, c(1994, 2001)) # plot two years sequentially
grwat::plot_separation(sep, 1994:1997, # plot four years on the same page
                       layout = matrix(c(1,2,3,4), nrow=2, byrow=TRUE))
```

## Read and test hydrograph variables

Interannual changes of parameters are read from _Total.txt_ file using `read_variables()` function:
```{r, message=FALSE}
setwd("/Volumes/Work/_grwat/Mezen_Malonisog/")

df = grwat::read_variables('Total.txt') # read parameters file
head(df)
```

To get the detailed description of available variables you can invoke `get_parameters()`:
```{r}
grwat::get_variables()
```

Parameters can be statistically tested using `test_variables(df, ..., year = NULL, locale='EN')` function. Names of the parameters are passed comma-separated in place of `...`. They are quoted, so you do not need to pass them as character strings, just write their names:
```{r}
grwat::test_variables(df, Qmax)
```

This is an example with three variables selected:
```{r}
tests = grwat::test_variables(df, Qygr, date10w1, Wpol3)
tests$pvalues
```

If you want to test all parameters, just skip variable names:
```{r}
tests = grwat::test_variables(df)
tests$change_year
```

Long-term changes are tested against breaking year, which is calculated for each variable using Pettitt test. However, if you want to use a fixed year, you should pass the desired breaking year into `change_year` parameter:
```{r}
tests = grwat::test_variables(df, Qmax, Qygr, change_year = 1987)
tests$ft # Fisher F tests to compare two variances
```

## Plot interannual changes

Interannual changes are visualized using `plot_variables()` function. Its syntax is similar to `test_variables()` and `plot_separation()`:

```{r, collapse=TRUE, message=FALSE}
grwat::plot_variables(df, Qmax) # plot one selected variable
grwat::plot_variables(df, date10w1, Wpol3) # plot two variables sequentially
grwat::plot_variables(df, Qmax, Qygr, date10w1, Wpol3, # plot four variables in matrix layout
                      layout = matrix(c(1,2,3,4), nrow=2, byrow=TRUE)) 
```

You can add the results of statistical tests to the plot by specifying the result of `test_variables()` function to the `tests` parameter. In that case the subtitle with test results will be added, Theil-Sen slope and Pettitt test breaking year are drawn as solid ($p \leq 0.05$) or dashed ($p > 0.05$) lines:

```{r, collapse=TRUE, message=FALSE}
grwat::plot_variables(df, date10w1, Wpol3, DaysThawWin, Qmaxpavs,
                      tests = test_variables(df, date10w1, Wpol3, DaysThawWin, Qmaxpavs)) # add test information
```

> Note that `tests` parameter of `plot_variables()` expects the tests for the same variables as those selected for plotting. If you plot variables A, B, C and supply tests for variables X, Y, Z, they will be added without any warnings, and it is your responsibility to keep them in correspondence with each other

Finally, you can plot all variables by not supplying column names to `plot_variables()` function. In that case tests (if you want to plot them too) should also be calculated for all variables:
```{r, eval=FALSE}
grwat::plot_variables(df, tests = test_variables(df))
```

## Plot long-term period changes 

Long-term changes are the differences between summarized statistics of one variable calculated for two selected periods. Because these statistics reflect the differences in distributions of parameters, grwat visualizes them as box plots using `plot_periods()` function. The syntax is similar to `plot_variables()` except that you must provide either `tests` or `year` parameter. If both are supplied then `tests` is prioritized (you can also supply a fixed year when testing variables:
```{r}
grwat::plot_periods(df, Qy, year = 1978)
grwat::plot_periods(df, Qy, tests = test_variables(df, Qy))
```

Multiple plots can be combined on one page using `layout` parameter:
```{r}
grwat::plot_periods(df, Qy, Qmax, 
                    tests = test_variables(df, Qy, Qmax),
                    layout = matrix(c(1,2)))
```

To plot long-term changes for all variables just skip variable names in function call:
```{r, eval = FALSE}
grwat::plot_periods(df, tests = test_variables(df))
```

There is also a small helper function that plots a histogram of minimal discharge month for summer and winter periods:
```{r, message=FALSE}
grwat::plot_minmonth(df, year = 1978)
```

# Report

The final feature of grwat package is reporting. Previous sections demonstrated various functions that allow different level of data processing: from individual tables, plots and maps to fully processed folders, tests and plots of multiple variables. Reporting allows you to produce a __single PDF file__ that provides a comprehensive overview of hydrograph separation and water discharge variables for the whole time period covered by your data. There are currently two functions that work with folder data:

- `report_gauge()` generates a report for a gauge folder containing _separation file_ `AllGrWat.txt`, _variables file_ `Total.txt` and map file `*.png`. 
- `report_basins()` generates multiple reports for the hierarchy of basin and gauge folders. It actually runs `report_gauge()` for every leaf subdirectory in the provided path.

The syntax of these functions is straightforward:
```{r, eval = FALSE}
grwat::report_gauge("/Volumes/Work/_grwat/2018/out/1_Sever/Mezen_Malonisog")
grwat::report_basins("/Volumes/Work/_grwat/2018/out/")
```

As a result of reporting each gauge folder gains _report.pdf_ (report) and _pvalues<gaugename>.xlsx_ (p-values of statistical tests) files:

![](report_folder.png)

A report file contains 5 sections:

1. Input data
2. Hydrograph separation
3. Interannual changes
4. Long-term changes
5. Statistical tests

They are organized in a compact form with multiple plots per page:

![](report.png)

> Note that reporting is a time-consuming operation since it produces dozens of high-quality plots. Therefore it is reasonable to run reporting functions from a separate R session if you want to perform another tasks in R at the same time. Or take a cup of coffee and watch your favourite TV series.